# Setup Guide - Passwordless Authentication

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **Node.js 18+** installed
3. **Amplify CLI** installed: `npm install -g @aws-amplify/cli`

## Step 1: Install Dependencies

```bash
npm install
```

## Step 2: Deploy the Backend

Start the Amplify sandbox:

```bash
npx ampx sandbox
```

This will:
- Deploy all backend resources (Auth, Data, Storage)
- Configure Cognito with native EMAIL_OTP passwordless authentication
- Set up the GraphQL API and DynamoDB tables
- Configure S3 bucket for property images
- Generate `amplify_outputs.json` for the frontend

Wait for the deployment to complete (usually 2-5 minutes).

**Note:** Cognito uses Amazon SES to send emails. By default, your AWS account is in SES sandbox mode, which means you can only send emails to verified addresses. For development, verify your email address in the [SES Console](https://console.aws.amazon.com/ses/). For production, request SES production access.

## Step 3: Start the Development Server

In a new terminal:

```bash
npm run dev
```

Open your browser to `http://localhost:5173`

## How Passwordless Authentication Works

1. **User enters email** - No password required
2. **System checks if user exists**:
   - If new user → Prompts for name to create account
   - If existing user → Proceeds to code verification
3. **8-digit code sent via email** - Using Cognito's native EMAIL_OTP
4. **User enters code** - Verified by Cognito
5. **User is authenticated** - JWT tokens issued

This uses Cognito's built-in EMAIL_OTP feature - no custom Lambda triggers needed!

## Testing the Flow

### First Time User

1. Enter your email address
2. Click "Continue with Email"
3. You'll see "Create Account" screen
4. Enter your name
5. Click "Create Account"
6. Check your email for the 8-digit code
7. Enter the code
8. You're signed in!

### Returning User

1. Enter your email address
2. Click "Continue with Email"
3. Check your email for the 8-digit code
4. Enter the code
5. You're signed in!

## Troubleshooting

### Email Not Received

- Check spam/junk folder
- Verify your email is verified in SES (if in sandbox mode)
- Check Cognito logs in CloudWatch for any email delivery issues
- For production use, request SES production access to send to any email

### "User Not Found" Error

- This is expected for new users
- The system will prompt you to create an account

### Code Verification Fails

- Ensure you're entering the correct 8-digit code
- Codes expire after 3 minutes (Cognito default)
- Try requesting a new code by going back and re-entering your email

### Authentication Flow Errors

Check CloudWatch Logs for Cognito:

```bash
# View Cognito logs
aws logs tail /aws/cognito/userpools --follow
```

## Configuring SES for Production

By default, AWS accounts are in SES sandbox mode. To send emails to any address:

1. Go to [AWS SES Console](https://console.aws.amazon.com/ses/)
2. Click "Account dashboard"
3. Click "Request production access"
4. Fill out the form with your use case
5. Wait for approval (usually 24-48 hours)

## Production Deployment

Deploy to Amplify Hosting:

```bash
npx ampx pipeline-deploy --branch main --app-id <your-app-id>
```

## Security Notes

- Uses Cognito's native EMAIL_OTP authentication
- Codes are randomly generated by Cognito
- Codes expire automatically (Cognito default: 3 minutes)
- Each code can only be used once
- Failed attempts are tracked and rate-limited by Cognito
- No passwords are stored or transmitted
- Built-in protection against brute force attacks

## Next Steps

- Customize email templates in Cognito User Pool settings
- Add SMS_OTP as an alternative authentication method
- Enable WebAuthn for biometric authentication
- Customize the UI styling
- Add multi-factor authentication for sensitive operations
